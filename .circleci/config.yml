version: 2.1
jobs:
  build:
    docker:
      - image: circleci/erlang:22
        environment:
          MIX_ENV: test
          SKIP_RELEASE: 0
          REL_CONFIG: with-all
          SKIP_COMPILE: 0
          SKIP_BUILD_TESTS: 0
          PRESET: internal_mnesia
          SKIP_COV: 0

    working_directory: ~/app

    steps:
      - checkout
      - restore_cache:
          key: deps-cache--{{ .Branch }}
      - run:
          name: Get deps
          command: |
            sudo apt install unixodbc-dev
            test 1 = "$SKIP_COV" || sudo apt install python-pip
            test 1 = "$SKIP_RELEASE" || tools/configure $REL_CONFIG
            test 1 = "$SKIP_COMPILE" || ./rebar3 get-deps
      - save_cache:
          key: deps-cache--{{ .Branch }}
          paths: ~/.cache/rebar3
      - restore_cache:
          key: build-cache-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Compile
          command: |
            test 1 = "$SKIP_COMPILE" || ./rebar3 compile
      - run:
          name: Make certs
          command: |
            test 1 = "$SKIP_COMPILE" || make certs
      - run:
          name: Install
          command: |
            test 1 = "$SKIP_RELEASE" || make devrel
            test 1 = "$SKIP_BUILD_TESTS" || tools/travis-build-tests.sh
            test 1 = "$SKIP_COV" || pip install --user codecov
      - save_cache:
          key: build-cache-{{ .Branch }}-{{ .Revision }}
          paths: _build
      - run:
          name: Setup database
          command: |
            tools/travis-setup-db.sh
            if [ $PRESET = 'ldap_mnesia' ]; then sudo tools/travis-setup-ldap.sh; fi
            if [ $PRESET = 'mysql_redis' ]; then sudo tools/travis-setup-rmq.sh; fi

  small_tests:
    docker:
      - image: circleci/erlang:22
        environment:
          MIX_ENV: test
          PRESET: internal_mnesia
    steps:
      - run:
          name: Setup database
          command: |
            KEEP_COVER_RUNNING=1 tools/travis-test.sh -p $PRESET -s true



workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - small_tests:
          requires:
            - build
