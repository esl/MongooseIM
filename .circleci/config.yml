version: 2.1
jobs:
  build:
    docker:
      - image: circleci/erlang:22
        environment:
          MIX_ENV: test
          SKIP_RELEASE: 0
          REL_CONFIG: with-all
          SKIP_COMPILE: 0
          SKIP_BUILD_TESTS: 0
          SKIP_COV: 0

    working_directory: ~/app

    steps:
      - checkout
      - restore_cache:
          key: deps-cache--{{ .Branch }}-{{ .Revision }}--{{ checksum "rebar.lock" }}
      - run:
          name: Get deps
          command: |
            sudo apt install unixodbc-dev
            test 1 = "$SKIP_COV" || sudo apt install python-pip
            test 1 = "$SKIP_RELEASE" || tools/configure $REL_CONFIG
            git config --global url."git://github".insteadOf https://github
            test 1 = "$SKIP_COMPILE" || ./rebar3 get-deps
      - save_cache:
          key: deps-cache--{{ .Branch }}-{{ .Revision }}--{{ checksum "rebar.lock" }}
          paths: ~/.cache/rebar3
      - run:
          name: Compile
          command: |
            test 1 = "$SKIP_COMPILE" || ./rebar3 compile
#      - restore_cache:
#          key: certs-cache--{{ .Branch }}-{{ .Revision }}
      - run:
          name: Make certs
          command: |
            test 1 = "$SKIP_COMPILE" || make certs
#      - save_cache:
#          key: certs-cache--{{ .Branch }}-{{ .Revision }}
#          paths: tools/ssl
      - restore_cache:
          key: build-cache-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Make devrel
          command: |
            test 1 = "$SKIP_RELEASE" || make devrel
            test 1 = "$SKIP_BUILD_TESTS" || tools/travis-build-tests.sh
            test 1 = "$SKIP_COV" || pip install --user codecov
      - save_cache:
          key: build-cache-{{ .Branch }}-{{ .Revision }}
          paths: _build