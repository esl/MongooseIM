# syntax=docker/dockerfile:1
# vi: ft=dockerfile

ARG builder_image
ARG target_image

############################
# BUILDER STAGE
############################
FROM ${builder_image} AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install -y \
    locales \
    git \
    make \
    zlib1g-dev \
    unixodbc-dev \
    gcc \
    g++ \
    libssl-dev \
    curl \
    gpg \
    && rm -rf /var/lib/apt/lists/*

# Required newer debsigs
RUN arch=$(dpkg --print-architecture) && \
    distro=$(grep ^ID= /etc/os-release | cut -d= -f2 | tr -d '"') && \
    if [ "$distro" = "ubuntu" ]; then \
        if [ "$arch" = "arm64" ]; then \
            echo "deb http://ports.ubuntu.com/ubuntu-ports plucky main universe multiverse" >> /etc/apt/sources.list; \
        else \
            echo "deb http://archive.ubuntu.com/ubuntu plucky main universe multiverse" >> /etc/apt/sources.list; \
        fi && \
        printf "Package: debsigs\nPin: release n=plucky\nPin-Priority: 990\n" > /etc/apt/preferences.d/debsigs; \
    elif [ "$distro" = "debian" ]; then \
        echo "deb http://deb.debian.org/debian trixie main" >> /etc/apt/sources.list && \
        printf "Package: debsigs\nPin: release n=trixie\nPin-Priority: 990\n" > /etc/apt/preferences.d/debsigs; \
    fi && \
    apt-get update && apt-get install -y --no-install-recommends debsigs && \
    sed -i '/plucky/d;/trixie/d' /etc/apt/sources.list

# Locale
RUN locale-gen en_US.UTF-8

# Copy full repo
WORKDIR /root
COPY . ./mongooseim

# ðŸ”‘ IMPORTANT:
# Copy deb scripts OUT of repo so we can reference them cleanly later
RUN cp -r ./mongooseim/tools/pkg/scripts/deb /root/deb

ARG erlang_version
ARG version
ARG revision

# Build deb package
RUN ./mongooseim/tools/pkg/scripts/deb/build_package.sh \
    "${version}" "${revision}" "${erlang_version}"

# Sign packages
RUN --mount=type=secret,id=GPG_PUBLIC_KEY,env=GPG_PUBLIC_KEY \
    --mount=type=secret,id=GPG_PRIVATE_KEY,env=GPG_PRIVATE_KEY \
    --mount=type=secret,id=GPG_PASS,env=GPG_PASS \
    ./mongooseim/tools/pkg/sign.sh

############################
# TARGET STAGE
############################
FROM ${target_image} AS target

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y openssl procps && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /root

# ðŸ‘‰ Copy built deb packages
COPY --from=builder /root/*.deb .

# ðŸ‘‰ Copy smoke test scripts (CORRECT LOCATION)
COPY --from=builder /root/deb/smoke_test.sh .
COPY --from=builder /root/deb/smoke_templates.escript .

# ðŸ‘‰ Copy helper script
COPY --from=builder /root/mongooseim/tools/wait-for-it.sh .

RUN chmod +x smoke_test.sh wait-for-it.sh

# Install mongooseim
RUN dpkg -i *.deb || apt-get -y -f install

# Run smoke tests
RUN ./smoke_test.sh

# Export packages
R
