ARG builder_image=ubuntu:22.04
ARG target_image=ubuntu:22.04

# ----------------------------
# Builder stage
# ----------------------------
FROM ${builder_image} AS builder

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    locales \
    ca-certificates \
    openssl \
    libssl-dev \
    unixodbc-dev \
    rebar3 \
    erlang \
    && rm -rf /var/lib/apt/lists/*

RUN locale-gen en_US.UTF-8

WORKDIR /root

# ðŸ‘‰ Copy entire repo
COPY . ./mongooseim

# ----------------------------
# Build deb package
# ----------------------------
WORKDIR /root/mongooseim

RUN make rel

# ----------------------------
# Target (runtime / smoke test) stage
# ----------------------------
FROM ${target_image} AS target

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    openssl \
    procps \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /root

# ðŸ‘‰ Copy built debs
COPY --from=builder /root/*.deb .

# ðŸ‘‰ Copy smoke test scripts (FIXED PATH)
COPY --from=builder /root/mongooseim/tools/pkg/scripts/smoke_test.sh .
COPY --from=builder /root/mongooseim/tools/pkg/scripts/smoke_templates.escript .

# ðŸ‘‰ Copy helper script
COPY --from=builder /root/mongooseim/tools/wait-for-it.sh .

RUN chmod +x smoke_test.sh wait-for-it.sh

# ----------------------------
# Smoke test
# ----------------------------
RUN ./smoke_test.sh

CMD ["bash"]
