.PHONY: all test console compile
all: test

# user overridable
TESTSPEC ?= default.spec
PRESET   ?= all
PREPARE  ?= prepare
ADD_OPTS ?= -sasl sasl_error_logger false -lager handlers []
TLS_DIST ?= no

# autogenerated, not intended for overriding
DEPS_PATHS := $(addprefix $(PWD)/../../_build/test/lib/,$(addsuffix /ebin,$(DEPS)))
APP_SRC_PATH := ../../src
SUBDIR_ERL_FILES := $(wildcard $(APP_SRC_PATH)/*/**.erl)
SUBDIR_ERL_FILES_IN_SRCDIR := $(foreach file,$(SUBDIR_ERL_FILES),$(APP_SRC_PATH)/$(notdir $(file)))

ifeq ($(TLS_DIST),yes)
TLS_DIST_OPTS := -args_file vm.dist.args
else
TLS_DIST_OPTS :=
endif

COMMON_OPTS := -sname test -setcookie ejabberd -hidden \
               $(TLS_DIST_OPTS) \
               -pa `pwd`/tests \
                   `pwd`/ebin \
                   `pwd`/deps/*/ebin \
               $(DEPS_PATHS)

ifeq ($(shell uname), Linux)
SED := sed
else
SED := gsed
endif

test_clean: get-deps
	rm -rf tests/*.beam
	$(MAKE) test

cover_test_clean: get-deps
	rm -rf tests/*.beam
	$(MAKE) cover_test

quicktest: $(PREPARE)
	erl -noinput $(COMMON_OPTS) $(ADD_OPTS) \
		-s run_common_test main test=quick spec=$(TESTSPEC) \
		> $@.log 2>&1 || (cat $@.log; exit 1)

pre_cover:
	@cp $(SUBDIR_ERL_FILES) $(APP_SRC_PATH)

post_cover:
	@rm $(SUBDIR_ERL_FILES_IN_SRCDIR)

cover_quicktest: pre_cover
	$(MAKE) do_cover_quicktest; STATUS=$$?; $(MAKE) post_cover; exit $$STATUS

cover_test_preset: pre_cover
	$(MAKE) do_cover_test_preset; STATUS=$$?; $(MAKE) post_cover; exit $$STATUS

cover_test: pre_cover
	$(MAKE) do_cover_test; STATUS=$$?; $(MAKE) post_cover; exit $$STATUS

do_cover_quicktest: $(PREPARE)
	erl -noinput $(COMMON_OPTS) $(ADD_OPTS) \
		-s run_common_test main test=quick spec=$(TESTSPEC) cover=true \
		> $@.log 2>&1 || (cat $@.log; exit 1)

test_preset: $(PREPARE)
	erl -noinput $(COMMON_OPTS) $(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) preset=$(PRESET) \
		> $@.log 2>&1 || (cat $@.log; exit 1)

do_cover_test_preset: $(PREPARE)
	erl -noinput $(COMMON_OPTS) $(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) preset=$(PRESET) cover=true \
		> $@.log 2>&1 || (cat $@.log; exit 1)

test: $(PREPARE)
	erl -noinput $(COMMON_OPTS) $(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) \
		> $@.log 2>&1 || (cat $@.log; exit 1)

do_cover_test: $(PREPARE)
	erl -noinput $(COMMON_OPTS) $(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) cover=true \
		> $@.log 2>&1 || (cat $@.log; exit 1)

prepare: mim_ct_rest compile vm.dist.args
	erlc -Ideps/exml/include \
		 run_common_test.erl
	mkdir -p ct_report

mim_ct_rest : \
	../../test/mim_ct_rest.erl \
	../../test/mim_ct_rest_handler.erl \
	../../test/mim_ct_sup.erl
	cp $^ src/

vm.dist.args: vm.dist.args.in certs
	$(SED) -e 's%__PWD__%$(PWD)%g' $< > $@

certs: priv/ssl/fake_cert.pem priv/ssl/fake_key.pem priv/ssl/cacert.pem

priv/ssl/fake_cert.pem priv/ssl/fake_key.pem priv/ssl/cacert.pem: \
  ../../tools/ssl/fake_cert.pem \
  ../../tools/ssl/fake_key.pem \
  ../../tools/ssl/ca/cacert.pem
	mkdir -p $(@D)
	cp $^ $(@D)/
	cat priv/ssl/fake_key.pem >> priv/ssl/fake_cert.pem

console: $(PREPARE)
	erl $(COMMON_OPTS) $(ADD_OPTS)

compile: get-deps
	./rebar compile > $@.log 2>&1 || (cat $@.log; exit 1)

get-deps: rebar
	./rebar get-deps > $@.log 2>&1 || (cat $@.log; exit 1)

clean: rebar
	-@rm priv/ssl/*
	-@rm -rf tests/*.beam > /dev/null 2>&1
	-@./rebar clean > /dev/null 2>&1

rebar:
	wget http://cloud.github.com/downloads/basho/rebar/rebar
	chmod u+x rebar
